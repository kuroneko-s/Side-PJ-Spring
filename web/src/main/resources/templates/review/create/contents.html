<html lang="en"
      xmlns:th="http://www.thymeleaf.org">

<main class="review-container">
    <!-- toast message start -->
    <div class="toast-message-container hide" id="toast-message-container">
        <div class="toast-message-wrapper">
            <p id="toast-message-context">이메일과 패스워드를 다시 입력해주세요.</p>
            <button type="button" class="toast-message-close-button" id="toast-message-close-button">
                <span>&times;</span>
            </button>
        </div>
    </div>
    <!-- toast message end -->

    <p class="review-title"><span th:text="${learning.title}"></span> 강의에 대한 평가를 남겨주세요!😊</p>

    <form id="reviewForm" class="review-form form" th:action="@{'/review/' + ${learning.id}}" method="POST">
        <label for="rating"></label>
        <select id="rating">
            <option value='0.5' selected>
                💔🤍🤍🤍🤍 0.5
            </option>
            <option value="1">
                ❤️🤍🤍🤍🤍 1.0
            </option>
            <option value="1.5">
                ❤️💔🤍🤍🤍 1.5
            </option>
            <option value="2">
                ❤️❤️🤍🤍🤍 2.0
            </option>
            <option value="2.5">
                ❤️❤️💔🤍🤍 2.5
            </option>
            <option value="3">
                ❤️❤️❤️🤍🤍 3.0
            </option>
            <option value="3.5">
                ❤️❤️❤️💔🤍 3.5
            </option>
            <option value="4">
                ❤️❤️❤️❤️🤍 4.0
            </option>
            <option value="4.5">
                ❤️❤️❤️❤️💔 4.5
            </option>
            <option value="5">
                ❤️❤️❤️❤️❤️ 5.0
            </option>
        </select>

        <label for="summernote"></label>
        <textarea id="summernote" type="textarea" required></textarea>
        <p><span id="max-size">0</span> / 100</p>
        <button type="submit" class="review-form-button">제출하기!</button>
    </form>
</main>

<!--description summernote-->

<script type="application/javascript">
    window.addEventListener("DOMContentLoaded", () => {
        const sizeCountEl = document.getElementById("max-size");

        $("#summernote").summernote({
            fontNames: ['Arial', 'Arial Black', 'Comic Sans MS', 'Courier New', 'Noto Sans KR', 'Merriweather'],
            placeholder: '강의에 대한 평가를 적어주세요!',
            tabSize: 2,
            lang: "ko-KR",
            height: 150,
            minWidth: 500,
            maxWidth: 875,
            focus: true,
            callbacks: {
                onKeydown: function (e) {
                    const text = e.target.textContent;
                    sizeCountEl.textContent = text.length;

                    if (text.length >= 100 && !["Backspace", "Delete"].includes(e.key)) {
                        e.preventDefault();
                    }
                },
                onPaste: function (e) {
                    alert("붙여넣기 할 수 없습니다!!");
                    e.preventDefault();
                }
            }
        });

        document.getElementById("reviewForm").addEventListener("submit", e => {
            e.preventDefault();

            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            const url = e.target.action;
            const description = document.getElementById("summernote").value;
            const rating = document.getElementById("rating").value;

            fetch(url, {
                method: "POST",
                body: JSON.stringify({ description, rating }),
                headers: {
                    [csrfHeader]: csrfToken,
                    "Content-Type": "application/json"
                }
            }).then(res => res.text())
            .then((text) => {
                if (text === "99") {
                    alert("리뷰가 등록된 강의입니다.");
                    self.close();
                } else {
                    alert("등록 되었습니다.");
                    self.close();
                }
            }).catch((err) => {
                console.log(err);
                alert("등록에 실패했습니다. 다시 시도해주세요.");
                self.close();
            })
        })
    })
</script>
</html>